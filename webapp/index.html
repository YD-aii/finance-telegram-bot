<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–§–∏–Ω–∞–Ω—Å—ã</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    input, select, button { padding: 8px; margin: 5px 0; width: 100%; }
  </style>
</head>
<body>
  <h2>üí∏ –í–∞—à–∏ —Ñ–∏–Ω–∞–Ω—Å—ã</h2>
  <p id="welcome">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
  <p><b>–ë–∞–ª–∞–Ω—Å:</b> <span id="balance">...</span> ‚ÇΩ</p>

  <h3>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
  <form onsubmit="addTransaction(); return false;">
    <select id="type">
      <option value="income">–î–æ—Ö–æ–¥</option>
      <option value="expense">–†–∞—Å—Ö–æ–¥</option>
    </select>
    <input id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required />
    <input id="amount" type="number" step="0.01" placeholder="–°—É–º–º–∞" required />
    <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
  </form>

  <h3>–û–ø–µ—Ä–∞—Ü–∏–∏</h3>
  <table id="transactions">
    <thead>
      <tr><th>–¢–∏–ø</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–°—É–º–º–∞</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const userId = tg.initDataUnsafe?.user?.id;
    document.getElementById("welcome").innerText = `–ü—Ä–∏–≤–µ—Ç, ${tg.initDataUnsafe?.user?.first_name || "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"}!`;

    async function loadData() {
      const res = await fetch(`/api/data?user_id=${userId}`);
      const data = await res.json();
      const tbody = document.querySelector("#transactions tbody");
      tbody.innerHTML = "";
      document.getElementById("balance").innerText = data.balance;

      data.transactions.forEach(t => {
        const row = `<tr><td>${t.type}</td><td>${t.name}</td><td>${t.amount}</td></tr>`;
        tbody.innerHTML += row;
      });
    }

    async function addTransaction() {
      const type = document.getElementById("type").value;
      const name = document.getElementById("name").value;
      const amount = parseFloat(document.getElementById("amount").value);

      const res = await fetch("/api/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: userId, type, name, amount })
      });

      const msg = await res.text();
      alert(msg);
      await loadData();
    }

    loadData();
  </script>
</body>
</html>

